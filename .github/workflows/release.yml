name: Create Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ.exe"
            artifact_name: "PicExam-Windows"
            asset_name: "PicExam-Windows.zip"
          - os: ubuntu-latest
            platform: linux
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ"
            artifact_name: "PicExam-Linux"
            asset_name: "PicExam-Linux.zip"
          - os: macos-latest
            platform: macos
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ"
            artifact_name: "PicExam-macOS"
            asset_name: "PicExam-macOS.zip"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        pyinstaller --name="å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ" ^
          --onefile ^
          --console ^
          --clean ^
          --add-data="ultra_fast_filter.py;." ^
          --add-data="remove_approval_tags.py;." ^
          --add-data="filter_config.json;." ^
          image_filter_main.py
      shell: cmd

    - name: Build executable (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        pyinstaller --name="å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ" \
          --onefile \
          --console \
          --clean \
          --add-data="ultra_fast_filter.py:." \
          --add-data="remove_approval_tags.py:." \
          --add-data="filter_config.json:." \
          image_filter_main.py

    - name: Prepare release files
      run: |
        mkdir -p release
      shell: bash

    - name: Copy files (Windows)
      if: matrix.platform == 'windows'
      run: |
        if exist "dist\å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ.exe" (
          copy "dist\å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ.exe" "release\"
          echo "Executable copied successfully"
        ) else (
          echo "ERROR: Executable not found!"
          exit /b 1
        )
        if exist "filter_config.json" (
          copy "filter_config.json" "release\"
          echo "filter_config.json copied successfully"
        ) else (
          echo "ERROR: filter_config.json not found!"
          exit /b 1
        )
        if exist "config.json" (
          copy "config.json" "release\"
          echo "config.json copied successfully"
        ) else (
          echo "config.json not found, skipping (optional file)"
        )
        echo "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ - Windowsç‰ˆæœ¬" > "release\README.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼šåŒå‡»è¿è¡Œ å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ.exe" >> "release\README.txt"
      shell: cmd

    - name: Copy files (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        if [ -f "dist/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ" ]; then
          cp "dist/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ" "release/"
          echo "Executable copied successfully"
        else
          echo "ERROR: Executable not found!"
          exit 1
        fi
        if [ -f "filter_config.json" ]; then
          cp "filter_config.json" "release/"
          echo "filter_config.json copied successfully"
        else
          echo "ERROR: filter_config.json not found!"
          exit 1
        fi
        if [ -f "config.json" ]; then
          cp "config.json" "release/"
          echo "config.json copied successfully"
        else
          echo "config.json not found, skipping (optional file)"
        fi
        echo "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ - ${{ matrix.platform }} ç‰ˆæœ¬" > "release/README.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ç»ˆç«¯ä¸­è¿è¡Œ ./å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ" >> "release/README.txt"
        chmod +x "release/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ"

    - name: Create ZIP archive
      run: |
        cd release
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a "../${{ matrix.asset_name }}" *
        else
          zip -r "../${{ matrix.asset_name }}" *
        fi
      shell: bash

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: ./${{ matrix.asset_name }}
        retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: ls -la ./artifacts/

    - name: Create Release and Upload All Assets
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        name: å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ ${{ steps.get_version.outputs.VERSION }}

          ### âœ¨ æ–°åŠŸèƒ½
          - åŸºäºæ™ºè°±AI GLM-4.1Vçš„å›¾ç‰‡å†…å®¹å®¡æŸ¥
          - æ”¯æŒæœ€é«˜30ä¸ªå¹¶å‘ä»»åŠ¡åŒæ—¶è¿›è¡Œ
          - è‡ªåŠ¨åˆ†ç±»ä¸é€‚å®œå†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
          - æ™ºèƒ½æ–‡ä»¶åæ£€æŸ¥åŠŸèƒ½

          ### ğŸš€ æ€§èƒ½ä¼˜åŒ–
          - å¼‚æ­¥IOå¤„ç†ï¼Œæå‡å¤„ç†é€Ÿåº¦
          - æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿ç¨³å®šæ€§
          - å†…å­˜ä¼˜åŒ–ï¼Œæ”¯æŒå¤§æ‰¹é‡å¤„ç†

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `PicExam-Windows.zip`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `PicExam-Linux.zip`
          - **macOSç”¨æˆ·**: ä¸‹è½½ `PicExam-macOS.zip`

          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          4. é…ç½®æ™ºè°±AIå¯†é’¥ ([è·å–åœ°å€](https://www.bigmodel.cn/usercenter/proj-mgmt/apikeys))
          5. å¼€å§‹æ‰¹é‡å¤„ç†å›¾ç‰‡

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: Ubuntu 18.04+ æˆ–å…¶ä»–ç°ä»£å‘è¡Œç‰ˆ
          - **macOS**: macOS 10.15+ (Catalina)
          - **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

          ---

          **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹æäº¤å†å²**
        files: ./artifacts/**/*.zip
        draft: false
        prerelease: false
        make_latest: true
        fail_on_unmatched_files: false
