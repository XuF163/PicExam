name: Create Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe"
            artifact_name: "PicExam-Gemini-Windows"
            asset_name: "PicExam-Gemini-Windows.zip"
          - os: ubuntu-latest
            platform: linux
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ"
            artifact_name: "PicExam-Gemini-Linux"
            asset_name: "PicExam-Gemini-Linux.zip"
          - os: macos-latest
            platform: macos
            executable_name: "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ"
            artifact_name: "PicExam-Gemini-macOS"
            asset_name: "PicExam-Gemini-macOS.zip"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        chcp 65001
        set PYTHONIOENCODING=utf-8
        python build_openai_version.py
      shell: cmd

    - name: Build executable (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        export PYTHONIOENCODING=utf-8
        python build_openai_version.py

    - name: Prepare release files
      run: |
        mkdir -p release
      shell: bash

    - name: Copy files (Windows)
      if: matrix.platform == 'windows'
      run: |
        if exist "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe" (
          copy "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe" "release\"
          echo "Executable copied successfully"
        ) else if exist "dist\å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe" (
          copy "dist\å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe" "release\"
          echo "Executable copied from dist successfully"
        ) else (
          echo "ERROR: Executable not found!"
          exit /b 1
        )
        if exist "filter_config.json" (
          copy "filter_config.json" "release\"
          echo "filter_config.json copied successfully"
        ) else (
          echo "ERROR: filter_config.json not found!"
          exit /b 1
        )
        if exist "config_examples.json" (
          copy "config_examples.json" "release\"
          echo "config_examples.json copied successfully"
        ) else (
          echo "config_examples.json not found, skipping (optional file)"
        )
        if exist "README.md" (
          copy "README.md" "release\"
          echo "README.md copied successfully"
        )
        if exist "GEMINI_MIGRATION_GUIDE.md" (
          copy "GEMINI_MIGRATION_GUIDE.md" "release\"
          echo "GEMINI_MIGRATION_GUIDE.md copied successfully"
        )
        echo "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ - Geminiç‰ˆ Windowsç‰ˆæœ¬" > "release\ä½¿ç”¨è¯´æ˜.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼šåŒå‡»è¿è¡Œ å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ.exe" >> "release\ä½¿ç”¨è¯´æ˜.txt"
        echo "é…ç½®æ–¹æ³•ï¼šå‚è€ƒ GEMINI_MIGRATION_GUIDE.md" >> "release\ä½¿ç”¨è¯´æ˜.txt"
        echo "æ–°ç‰¹æ€§ï¼šæ”¯æŒGoogle Gemini AIï¼Œæ— é™é‡è¯•æœºåˆ¶ï¼Œ100%%å®¡æŸ¥è¦†ç›–ç‡" >> "release\ä½¿ç”¨è¯´æ˜.txt"
      shell: cmd

    - name: Copy files (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        if [ -f "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ" ]; then
          cp "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ" "release/"
          echo "Executable copied successfully"
        elif [ -f "dist/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ" ]; then
          cp "dist/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ" "release/"
          echo "Executable copied from dist successfully"
        else
          echo "ERROR: Executable not found!"
          exit 1
        fi
        if [ -f "filter_config.json" ]; then
          cp "filter_config.json" "release/"
          echo "filter_config.json copied successfully"
        else
          echo "ERROR: filter_config.json not found!"
          exit 1
        fi
        if [ -f "config_examples.json" ]; then
          cp "config_examples.json" "release/"
          echo "config_examples.json copied successfully"
        else
          echo "config_examples.json not found, skipping (optional file)"
        fi
        if [ -f "README.md" ]; then
          cp "README.md" "release/"
          echo "README.md copied successfully"
        fi
        if [ -f "GEMINI_MIGRATION_GUIDE.md" ]; then
          cp "GEMINI_MIGRATION_GUIDE.md" "release/"
          echo "GEMINI_MIGRATION_GUIDE.md copied successfully"
        fi
        echo "å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ - Geminiç‰ˆ ${{ matrix.platform }} ç‰ˆæœ¬" > "release/ä½¿ç”¨è¯´æ˜.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ç»ˆç«¯ä¸­è¿è¡Œ ./å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ" >> "release/ä½¿ç”¨è¯´æ˜.txt"
        echo "é…ç½®æ–¹æ³•ï¼šå‚è€ƒ GEMINI_MIGRATION_GUIDE.md" >> "release/ä½¿ç”¨è¯´æ˜.txt"
        echo "æ–°ç‰¹æ€§ï¼šæ”¯æŒGoogle Gemini AIï¼Œæ— é™é‡è¯•æœºåˆ¶ï¼Œ100%å®¡æŸ¥è¦†ç›–ç‡" >> "release/ä½¿ç”¨è¯´æ˜.txt"
        chmod +x "release/å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ_Geminiç‰ˆ"

    - name: Create ZIP archive
      run: |
        cd release
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a "../${{ matrix.asset_name }}" *
        else
          zip -r "../${{ matrix.asset_name }}" *
        fi
      shell: bash

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: ./${{ matrix.asset_name }}
        retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: ls -la ./artifacts/

    - name: Create Release and Upload All Assets
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        name: å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ Geminiç‰ˆ ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## å›¾ç‰‡å†…å®¹è¿‡æ»¤ç³»ç»Ÿ Geminiç‰ˆ ${{ steps.get_version.outputs.VERSION }}

          ### ğŸ¯ é‡å¤§æ›´æ–°ï¼šè¿ç§»åˆ°Google Gemini AI
          - **å…¨æ–°AIå¼•æ“**ï¼šä»æ™ºè°±AIè¿ç§»åˆ°Google Gemini 2.5 Pro
          - **åŒæ¨¡å¼æ”¯æŒ**ï¼šæ”¯æŒå®˜æ–¹Gemini APIå’Œä»£ç†æœåŠ¡å™¨
          - **æ— é™é‡è¯•æœºåˆ¶**ï¼šç¡®ä¿100%å®¡æŸ¥è¦†ç›–ç‡ï¼Œä¸å†æœ‰é—æ¼
          - **æ™ºèƒ½å¼‚å¸¸å¤„ç†**ï¼šè‡ªé€‚åº”å¹¶å‘æ•°è°ƒæ•´å’ŒæŒ‡æ•°é€€é¿é‡è¯•

          ### âœ¨ æ ¸å¿ƒåŠŸèƒ½
          - åŸºäºGoogle Gemini 2.5 Proçš„é«˜ç²¾åº¦å›¾ç‰‡å†…å®¹å®¡æŸ¥
          - æ”¯æŒæœ€é«˜30ä¸ªå¹¶å‘ä»»åŠ¡åŒæ—¶è¿›è¡Œ
          - è‡ªåŠ¨åˆ†ç±»ä¸é€‚å®œå†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
          - æ™ºèƒ½å›¾ç‰‡å‹ç¼©ï¼šå¤šçº§è´¨é‡å‹ç¼©ç¡®ä¿APIå…¼å®¹æ€§

          ### ğŸš€ æ€§èƒ½ä¸å¯é æ€§ä¼˜åŒ–
          - **100%å®¡æŸ¥è¦†ç›–ç‡**ï¼šç§»é™¤æ‰€æœ‰é»˜è®¤é€šè¿‡é€»è¾‘
          - **æ— é™é‡è¯•**ï¼šç½‘ç»œæ•…éšœå’ŒAPIé™æµä¸å†å¯¼è‡´é—æ¼
          - **æ™ºèƒ½é”™è¯¯å¤„ç†**ï¼š429é™æµã€ç½‘ç»œé”™è¯¯è‡ªåŠ¨å¤„ç†
          - **è‡ªé€‚åº”å»¶è¿Ÿ**ï¼šæ ¹æ®APIå“åº”åŠ¨æ€è°ƒæ•´è¯·æ±‚é¢‘ç‡

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `PicExam-Gemini-Windows.zip`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `PicExam-Gemini-Linux.zip`
          - **macOSç”¨æˆ·**: ä¸‹è½½ `PicExam-Gemini-macOS.zip`

          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
          4. é…ç½®Google Gemini APIå¯†é’¥ ([è·å–åœ°å€](https://aistudio.google.com/app/apikey))
          5. å¼€å§‹æ‰¹é‡å¤„ç†å›¾ç‰‡

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: Ubuntu 18.04+ æˆ–å…¶ä»–ç°ä»£å‘è¡Œç‰ˆ
          - **macOS**: macOS 10.15+ (Catalina)
          - **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥ï¼ˆæ”¯æŒGoogleæœåŠ¡ï¼‰

          ### ğŸ”„ è¿ç§»è¯´æ˜
          - ä»æ—§ç‰ˆæœ¬å‡çº§éœ€è¦é‡æ–°é…ç½®APIå¯†é’¥
          - è¯¦ç»†è¿ç§»æŒ‡å—è¯·å‚è€ƒåŒ…å†…çš„ `GEMINI_MIGRATION_GUIDE.md`
          - æ”¯æŒä»£ç†æœåŠ¡å™¨é…ç½®ä»¥é€‚åº”ä¸åŒç½‘ç»œç¯å¢ƒ

          ---

          **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹æäº¤å†å²**
        files: ./artifacts/**/*.zip
        draft: false
        prerelease: false
        make_latest: true
        fail_on_unmatched_files: false
